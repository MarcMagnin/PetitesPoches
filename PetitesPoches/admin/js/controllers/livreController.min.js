var Livre=function(){this.Index=0;this.Titre="";this.Couverture="";this.Auteur={Nom:"",Prenom:""};this.Prix="";this.ISBN="";this.EBookUrl="";this.NiveauLecture="";this.PrixLitteraire="";this.FichePedago="";this.Extrait="";this.SiteMarchand="";this.LienVideo="";this.LienIssu=""},Update=function(){this.Type="";this.Name=""};app.controller("livreController",["$scope","$rootScope","$http","$timeout","$upload","$state","$modal","$q","$filter","livreService",function(n,t,i,r,u,f,e,o,s,h){n.itemsPool=[];n.items=[];n.tags=[];n.selectedItem="";n.searchedAuteur="";n.entityName="Livre";n.searchedText="";n.whiteSpacePattern="/ /g";n.searchTimeout;n.checkboxPrixLitteraire;n.container=$(".tilesContainer");n.niveauLecture="";n.themeMultiselectSettings={displayProp:"Name",idProp:"Name"};n.themeMultiselectmodel=[];n.menuShown=!0;n.init=function(){itemAdded=0;h.getLivres().then(function(t){n.itemsPool=t;angular.forEach(t,function(t){t.Id=t["@metadata"]["@id"];t.filter=t.Titre.split(" ").map(function(n){return"fil-"+cleanString(n)}).join(" ");t.Auteur.Nom&&(t.filter+=" fil-"+t.Auteur.Nom.split(" ").map(function(n){return"fil-"+cleanString(n)}).join(" "));t.Auteur.Prenom&&(t.filter+=" fil-"+t.Auteur.Prenom.split(" ").map(function(n){return"fil-"+cleanString(n)}).join(" "));t.PrixLitteraires&&(t.filter+=" f-prix");t.EBookUrl&&(t.filter+=" f-ebook");t.FichePedago&&(t.filter+=" f-pedago");t.NiveauLecture&&(t.filter+=" f-"+t.NiveauLecture);t.Tags&&(t.filter+=" "+s("filterString")(t.Tags));n.items.push(t)})});i({method:"GET",url:t.apiRootUrl+"/indexes/Tags?pageSize=30&sort=Name&noCache=1015157938&_="+Date.now()}).success(function(t){n.tags=t.Results}).error(function(n){console.log(n)})};n.select=function(t,i,r){if(n.selectedItem=t,!$(r.target).closest("a").length){var u=e.open({templateUrl:"myModalContent.html",controller:"ModalInstanceCtrl",size:i,resolve:{selectedItem:function(){return n.selectedItem},parentScope:function(){return n}}});u.result.then(function(){n.saveItem(n.selectedItem)},function(){})}};n.saveItem=function(r){delete r.new;var u=r.filter;delete r.filter;i({method:"PUT",headers:{"Raven-Entity-Name":"Livre"},url:t.apiRootUrl+"/docs/"+r.Id,data:angular.toJson(r)}).success(function(){r.filter=u;n.container.isotope("updateSortData",n.container.find(".isotopey"));n.container.isotope({sortBy:"date"})}).error(function(n){r.filter=u;console.log(n)})};n.tryRemoveAttachment=function(n,r){n[r]&&i({method:"DELETE",url:t.apiRootUrl+"/"+n[r]}).success(function(){}).error(function(n){console.log(n)})};n.addFile=function(r,f,e){var s=n.selectedItem,o,h;n.tryRemoveAttachment(s,e);o=r[0];h=new FileReader;h.onload=function(r){n.upload=u.http({url:t.apiRootUrl+"/static/"+s.Id+"/"+o.name,method:"PUT",headers:{"Content-Type":o.type},data:r.target.result}).progress(function(n){console.log("percent: "+parseInt(100*n.loaded/n.total))}).success(function(){var r=new Update;r.Type="Set";r.Name=e;r.Value=o.name;i({method:"PATCH",headers:{"Raven-Entity-Name":n.entityName},url:t.apiRootUrl+"/docs/"+s.Id,data:angular.toJson(new Array(r))}).success(function(){s[e]=o.name}).error(function(n){console.log(n)})}).error(function(){alert("Error occured during upload")})};h.readAsArrayBuffer(o)};n.updateAttachment=function(i,r,f){var o=n.selectedItem,e,s;n.tryRemoveAttachment(o,f);e=i[0];s=new FileReader;s.onload=function(i){n.upload=u.http({url:t.apiRootUrl+"/static/"+o.Id+"/"+e.name,method:"PUT",headers:{"Content-Type":e.type},data:i.target.result}).progress(function(n){console.log("percent: "+parseInt(100*n.loaded/n.total))}).success(function(){n.setAttachment(e.name,o,f)}).error(function(){alert("Error occured during upload")})};s.readAsArrayBuffer(e)};n.setAttachment=function(r,u,f){var o="static/"+u.Id+"/"+r,e=new Update;e.Type="Set";e.Name=f;e.Value=o;i({method:"PATCH",headers:{"Raven-Entity-Name":n.entityName},url:t.apiRootUrl+"/docs/"+u.Id,data:angular.toJson(new Array(e))}).success(function(){u[f]=o}).error(function(n){console.log(n)})};n.addLivre=function(r){return i({method:"PUT",headers:{"Raven-Entity-Name":n.entityName},url:t.apiRootUrl+"/docs/"+n.entityName+"%2F",data:angular.toJson(r)})};n.addLivreByDragAndDrop=function(i){var r=[];angular.forEach(i,function(i){var f=new Livre,e;f.datePublication=moment().format();e=o.defer();r.push(e.promise);n.addLivre(f).success(function(r){f.Id=r.Key;n.itemsPool.push(f);n.items.push(f);e.resolve();var o=new FileReader;o.onload=function(r){u.http({url:t.apiRootUrl+"/static/"+f.Id+"/"+i.name,method:"PUT",headers:{"Content-Type":i.type},data:r.target.result}).progress(function(n){console.log("percent: "+parseInt(100*n.loaded/n.total))}).success(function(){n.setAttachment(i.name,f,"Couverture")}).error(function(){alert("Error occured during upload")})};o.readAsArrayBuffer(i)}).error(function(n){console.log(n)})});o.all(r).finally(function(){n.sort()})};n.getPrixSuggestions=function(r){return n.loading=!0,i.get(t.apiRootUrl+"/indexes/PrixLitteraireSuggestions",{params:{query:"Value:"+r+"*",pageSize:10,_:Date.now()}}).then(function(t){return n.loading=!1,t.data.Results})};n.cancel=function(){n.modalInstance.dismiss("cancel")};n.add=function(){var r=new Livre;r.datePublication=moment().format();n.selectedItem=r;i({method:"PUT",headers:{"Raven-Entity-Name":n.entityName},url:t.apiRootUrl+"/docs/"+n.entityName+"%2F",data:angular.toJson(r)}).success(function(t){r.Id=t.Key;r.new=!0;n.itemsPool.unshift(r);n.items.unshift(r);TweenMax.to(".tile",.2,{opacity:1});var i=e.open({templateUrl:"myModalContent.html",controller:"ModalInstanceCtrl",resolve:{selectedItem:function(){return n.selectedItem},parentScope:function(){return n}}});i.result.then(function(){n.saveItem(n.selectedItem)},function(){n.deleteLivre(n.selectedItem)})}).error(function(n){console.log(n)})};n.deleteLivre=function(r,u){u&&(u.stopPropagation(),u.stopImmediatePropagation());r.Couverture&&i({method:"DELETE",url:t.apiRootUrl+"/"+r.Couverture}).success(function(){}).error(function(n){console.log(n)});r.FichePedago&&i({method:"DELETE",url:t.apiRootUrl+"/static/"+r.Id+"/"+r.FichePedago}).success(function(){}).error(function(n){console.log(n)});i({method:"DELETE",headers:{"Raven-Entity-Name":"Livre"},url:t.apiRootUrl+"/docs/"+r.Id}).success(function(){n.items.splice(n.items.indexOf(r),1);setTimeout(function(){n.container.isotope("reLayout")},100)}).error(function(n){console.log(n)})};n.searchSuggestionsValue;n.searchLivreSuggestions=function(r){return n.searchSuggestionsValue=r,n.loadingSearchSuggestions=!0,i({method:"GET",url:t.apiRootUrl+"/indexes/LivreSearchSuggestions",params:{query:"Titre:"+r+"* OR Nom:"+r+"* OR Prenom:"+r+"*",pageSize:10}}).then(function(t){return n.loadingSearchSuggestions=!1,t.data.Results.forEach(function(t){t.imageUrl=n.apiRootUrl+"/"+t.Couverture}),t.data.Results})};n.validateSearchFromLivre=function(t){(t.Auteur&&t.Auteur.Nom.toLowerCase().indexOf(n.searchSuggestionsValue.toLowerCase())>-1||t.Auteur.Prenom.toLowerCase().indexOf(n.searchSuggestionsValue.toLowerCase())>-1)&&(n.searchedText=t.Auteur.Prenom+" "+t.Auteur.Nom)};n.validateFilter=function(){var t=(n.searchPatternEBook?n.searchPatternEBook:"")+(n.searchPatternPrixLitteraires?n.searchPatternPrixLitteraires:"")+(n.searchPatternRecherche?n.searchPatternRecherche:"")+(n.filterPatternNiveauLecture?n.filterPatternNiveauLecture:"")+(n.searchPatternTheme?n.searchPatternTheme:"");n.container.isotope({filter:t})};n.filtreNiveauLecture=function(){n.filterPatternNiveauLecture=n.niveauLecture?".f-"+n.niveauLecture:"";n.validateFilter()};n.searchEBook=function(){n.searchPatternEBook=n.checkboxSearchEBook?".f-ebook":"";n.validateFilter()};n.searchPrixLitteraires=function(){n.searchPatternPrixLitteraires=n.checkboxPrixLitteraire?".f-prix":"";n.validateFilter()};n.filtreThemes=function(){n.searchPatternTheme=n.themeMultiselectmodel.map(function(n){return".f-"+n.Name.toLowerCase().replace(/ /g,"")}).join("");n.validateFilter()};n.validateSearch=function(){n.searchTimeout&&clearTimeout(n.searchTimeout);n.searchTimeout=setTimeout(function(){n.searchedText.Titre?(n.searchPatternRecherche=n.searchedText.Titre.split(" ").map(function(n){return"[class*='fil-"+cleanString(n)+"']"}).join(""),console.log(n.searchPatternRecherche)):n.searchPatternRecherche=n.searchedText.split(" ").map(function(n){return"[class*='fil-"+cleanString(n)+"']"}).join("");n.validateFilter()},300)};n.searchAuteurSuggestions=function(r){return n.loadingSearchSuggestions=!0,i({method:"GET",url:t.apiRootUrl+"/indexes/AuteurSearchSuggestion",params:{query:"Nom:"+r+"* OR Prenom:"+r+"*",resultsTransformer:"AuteurSearchTransform",pageSize:10}}).then(function(t){return n.loadingSearchSuggestions=!1,t.data.Results})};n.clear=function(){n.selectedItem.datePublication=null};n.toggleMin=function(){n.minDate=n.minDate?null:new Date};n.toggleMin();n.open=function(t){t.preventDefault();t.stopPropagation();n.opened=!0};n.dateOptions={formatYear:"yy",startingDay:1};n.formats=["dd-MMMM-yyyy","dd/MM/yyyy","dd.MM.yyyy","shortDate"];n.format=n.formats[1];n.sort=function(){setTimeout(function(){n.container.isotope({sortBy:"date"})},100)}}]);
//# sourceMappingURL=livreController.min.js.map
